# Claude Code PR Review â€” drop into .github/workflows/ of any repo
# Requires: ANTHROPIC_API_KEY secret + Claude GitHub App installed
# Setup: run /install-github-app inside Claude Code, or manually:
#   1. Install https://github.com/apps/claude on your repo
#   2. Add ANTHROPIC_API_KEY to repo secrets (from console.anthropic.com)

name: Claude Code Review

permissions:
  contents: read
  pull-requests: write
  issues: write

on:
  # Auto-review on PR open/update
  pull_request:
    types: [opened, synchronize]
  # Respond to @claude mentions
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  # Auto-review: runs on every PR (uses Haiku for cost efficiency)
  auto-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Review this PR for:
            1. Security issues (injection, auth bypass, secrets in code)
            2. Obvious bugs or logic errors
            3. Breaking changes not mentioned in the PR description

            Be concise. Only flag real issues, not style preferences.
            If the PR looks clean, say so in one sentence.
          claude_args: "--model claude-haiku-4-5-20251001 --max-turns 5"

  # Interactive: responds to @claude mentions (uses Sonnet for deeper analysis)
  interactive:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: "--model claude-sonnet-4-6 --max-turns 10"
