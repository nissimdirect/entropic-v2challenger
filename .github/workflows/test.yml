name: Entropic v2 Tests
on: [push, pull_request]

jobs:
  smoke:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install backend deps
        run: cd backend && pip install -e ".[dev]"
      - name: Run backend smoke tests
        run: cd backend && python -m pytest tests/ -m smoke --tb=short -q
      - name: Install frontend deps
        run: cd frontend && npm ci
      - name: Run frontend unit tests
        run: cd frontend && npx vitest run

  sidecar:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install backend deps
        run: cd backend && pip install -e ".[dev]"
      - name: Run sidecar tests
        run: cd backend && python -m pytest tests/ -v --tb=short -m "not perf" -p no:timeout

  electron-e2e:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install backend deps
        run: cd backend && pip install -e ".[dev]"
      - name: Install frontend deps
        run: cd frontend && npm ci
      - name: Install Playwright
        run: cd frontend && npx playwright install
      - name: Generate test fixtures
        run: bash scripts/generate-test-fixtures.sh
      - name: Build Electron app
        run: cd frontend && npx electron-vite build
      - name: Run smoke test
        run: cd frontend && npx playwright test tests/e2e/smoke.spec.ts
      - name: Run E2E tests
        run: cd frontend && npx playwright test tests/e2e/
        env:
          CI: '1'
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results
          path: frontend/test-results/
